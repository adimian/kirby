<!DOCTYPE html>
{% extends 'admin/master.html' %}
{% block body %}

<style>
#log_display {
    height: 60vh;
    overflow-y: scroll;
    padding: 0 10px;
    padding-top: 0px;
    padding-right: 10px;
    padding-bottom: 0px;
    padding-left: 10px;
    margin-top: 20px;
    border: 1px solid #ececec;
}

.scroller * {
    overflow-anchor: none;
}

#anchor {
    overflow-anchor: auto;
    height: 1px;
}

.log * {
    margin: 0px;
    display: inline;
}

.critical{
    color: #c0392b;
}
.error{
    color: #f39c12;
}
.warning{
    color: #f1c40f;
}
.info{
    color: #145a32;
}
.debug{
    color: #2471a3;
    font-style: italic;
}
</style>


Package name: <select id="package_name_input"></select> Filter: <select id="filter_log_level">
    <option selected value=0>All</option>
    <option value=50>CRITICAL</option>
    <option value=40>ERROR</option>
    <option value=30>WARNING</option>
    <option value=20>INFO</option>
    <option value=10>DEBUG</option>
</select>

<div id="log_display" class="scroller">
    <div id="anchor"></div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<script>
function filterLogs(logs){
    var log_level = $("#filter_log_level").val();
    for (var i = 0; i < logs.length; i++) {
        var log = logs[i];
        var log_value = log.getAttribute('value');
        if (log_value < log_level) {
            log.style.display = "none";
        } else {
            log.style.display = "block";
        }
    }
}

function filterExistingLogs(){
    filterLogs(document.getElementsByClassName("log"));
}

function getNewLogs(){
    $.ajax({
        url: "/admin/log/new_logs",
        type: "get",
        data: {package_name: $("#package_name_input").val()},
        success: function(raw_json) {
            json = JSON.parse(raw_json);
            var new_logs = [];
            $.each(json.logs, function(idx, log){
                var new_log = $("<div class='log' value= " + log.value + "><p>" + log.timestamp + " :</p><p class='" + log.level + "'> \[" + log.level.toUpperCase() + "\] " + log.message + "</p></div>").insertBefore($("#anchor"));
                new_logs.push(new_log[0]);
            });
            if (new_logs.length > 0){
                filterLogs(new_logs);
            }
        }
    });
    }

function initLogPage() {
    // Init package_name_input
    $.ajax({
        url: "/admin/log/script_list",
        type: "get",
        data: {},
        success: function(json) {
            var script_list = JSON.parse(json);
            $("#package_name_input").append("<option>--Select package--</option>");
            $.each(script_list, function(idx, script){
                $("#package_name_input").append("<option>" + script +"</option>");
            });
        }
    });

    // setInterval
    setInterval(getNewLogs,500);
}

function clearLogDisplay() {
    $('#log_display').contents(':not(#anchor)').remove();
}

$("#package_name_input").change(clearLogDisplay);
$("#filter_log_level").change(filterExistingLogs);
window.onload = initLogPage;

</script>
{% endblock body %}